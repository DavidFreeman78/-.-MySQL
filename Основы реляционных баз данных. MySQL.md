--Lesson_8

use vk;

-- Практическое задание по теме “Операторы, фильтрация, сортировка и ограничение. Агрегация данных”. Работаем с БД vk и данными, которые вы сгенерировали ранее:
-- Задачи необходимо решить с использованием объединения таблиц (JOIN)

/* Задача 1
Пусть задан некоторый пользователь. Из всех пользователей соц. сети найдите человека, который больше всех общался с выбранным пользователем (написал ему сообщений).
*/

WITH T AS (
	SELECT to_user_id AS best_friend_id FROM messages WHERE from_user_id = 2
	union ALL
	SELECT from_user_id  FROM messages WHERE to_user_id = 2
)
SELECT U.firstname, count(*) as rate FROM T
	INNER JOIN users U 
		ON U.id = T.best_friend_id
GROUP BY best_friend_id
ORDER BY rate DESC
LIMIT 1;

/* Задача 2
Подсчитать общее количество лайков, которые получили пользователи младше 10 лет..
*/

SELECT count(*) AS YU FROM profiles JOIN likes USING(user_id) WHERE year(now())-year(birthday) < 10;
-- YU = Young Users

/* Задача 3
Определить кто больше поставил лайков (всего): мужчины или женщины.
*/


SELECT CASE gender
      WHEN 'm' THEN 'мужчины'
      WHEN 'f' THEN 'женщины'
    END as gender, COUNT(*) as likes_count
  FROM profiles as p
    JOIN likes as l
      ON p.user_id = l.user_id
  GROUP BY gender;
